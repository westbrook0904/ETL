3. Java 参数模型类
package com.dataloader.model;import lombok.Data;import lombok.Builder;import lombok.AllArgsConstructor;import lombok.NoArgsConstructor;import java.util.List;import java.util.Map;/** * 带条件检查的 Upsert 参数 */@Data@Builderpublic class ConditionalUpsertParam {    /**     * 表名     */    private String tableName;        /**     * 所有字段列表（用于 INSERT）     */    private List<String> fields;        /**     * 需要更新的字段列表（通常排除主键）     */    private List<String> updateFields;        /**     * 数据列表（每条数据可以有独立的条件检查）     */    private List<DataWithCondition> dataList;        /**     * 需要自动递增的字段（如 version, retry_count 等）     */    private List<String> autoIncrementFields;        /**     * 自动更新时间字段     */    private String autoUpdateTimeField;        /**     * 带条件检查的数据项     */    @Data    @Builder    @NoArgsConstructor    @AllArgsConstructor    public static class DataWithCondition {        /**         * 实际数据         */        private Map<String, Object> data;                /**         * 条件检查列表（所有条件必须同时满足才执行更新）         */        private List<ConditionCheck> conditionChecks;    }        /**     * 条件检查     */    @Data    @Builder    @NoArgsConstructor    @AllArgsConstructor    public static class ConditionCheck {        /**         * 字段名         */        private String fieldName;                /**         * 期望值（只有数据库中的值等于期望值时才更新）         */        private Object expectedValue;                /**         * 操作符（默认是 =，可扩展为 >, <, >= 等）         */        private String operator = "=";    }}
4. 扩展版：支持更多操作符
如果需要支持 >, <, >=, <=, != 等操作符：
<insert id="batchUpsertWithConditionAdvanced">    <foreach collection="dataList" item="item" separator=";">        INSERT INTO ${tableName} (            <foreach collection="fields" item="field" separator=",">                ${field}            </foreach>        ) VALUES (            <foreach collection="fields" item="field" separator=",">                #{item.data.${field}}            </foreach>        )        ON DUPLICATE KEY UPDATE            <foreach collection="updateFields" item="field" separator=",">                ${field} = IF(                    <choose>                        <when test="item.conditionChecks != null and item.conditionChecks.size() > 0">                            <foreach collection="item.conditionChecks" item="check" separator=" AND ">                                <!-- 根据操作符类型构建条件 -->                                <choose>                                    <when test="check.operator == '='">                                        ${check.fieldName} = #{check.expectedValue}                                    </when>                                    <when test="check.operator == '>'">                                        ${check.fieldName} &gt; #{check.expectedValue}                                    </when>                                    <when test="check.operator == '>='">                                        ${check.fieldName} &gt;= #{check.expectedValue}                                    </when>                                    <when test="check.operator == '<'">                                        ${check.fieldName} &lt; #{check.expectedValue}                                    </when>                                    <when test="check.operator == '<='">                                        ${check.fieldName} &lt;= #{check.expectedValue}                                    </when>                                    <when test="check.operator == '!='">                                        ${check.fieldName} != #{check.expectedValue}                                    </when>                                    <when test="check.operator == 'IN'">                                        ${check.fieldName} IN                                         <foreach collection="check.expectedValues" item="val" open="(" separator="," close=")">                                            #{val}                                        </foreach>                                    </when>                                    <otherwise>                                        ${check.fieldName} = #{check.expectedValue}                                    </otherwise>                                </choose>                            </foreach>                        </when>                        <otherwise>                            1=1                        </otherwise>                    </choose>                    ,                    #{item.data.${field}},                    ${field}                )            </foreach>            <if test="autoIncrementFields != null">                <foreach collection="autoIncrementFields" item="autoField">                    , ${autoField} = IF(                        <if test="item.conditionChecks != null and item.conditionChecks.size() > 0">                            <foreach collection="item.conditionChecks" item="check" separator=" AND ">                                ${check.fieldName} ${check.operator} #{check.expectedValue}                            </foreach>,                        </if>                        <if test="item.conditionChecks == null or item.conditionChecks.size() == 0">                            1=1,                        </if>                        ${autoField} + 1,                        ${autoField}                    )                </foreach>            </if>            <if test="autoUpdateTimeField != null">                , ${autoUpdateTimeField} = IF(                    <if test="item.conditionChecks != null and item.conditionChecks.size() > 0">                        <foreach collection="item.conditionChecks" item="check" separator=" AND ">                            ${check.fieldName} ${check.operator} #{check.expectedValue}                        </foreach>,                    </if>                    <if test="item.conditionChecks == null or item.conditionChecks.size() == 0">                        1=1,                    </if>                    NOW(),                    ${autoUpdateTimeField}                )            </if>    </foreach></insert>
5. 使用示例
