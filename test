-- =====================================================
-- ETL 数据处理管道 - 数据库表设计
-- =====================================================

-- 1. 管道基础信息表
CREATE TABLE pipeline_basic_info (
    pipeline_code VARCHAR(64) PRIMARY KEY COMMENT '管道编码',
    name VARCHAR(128) NOT NULL COMMENT '管道名称',
    description VARCHAR(512) COMMENT '管道描述',
    version INT DEFAULT 1 COMMENT '管道版本',
    status TINYINT DEFAULT 0 COMMENT '管道状态：0-草稿 1-启用 2-禁用 3-已归档',
    schedule_config VARCHAR(256) COMMENT '调度配置（cron表达式或其他调度策略）',
    creator VARCHAR(64) COMMENT '创建人',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updater VARCHAR(64) COMMENT '更新人',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    remark VARCHAR(512) COMMENT '备注',
    INDEX idx_status (status),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='管道基础信息表';

-- 2. 抽取组件基础信息表
CREATE TABLE extraction_component_basic_info (
    component_code VARCHAR(64) PRIMARY KEY COMMENT '组件编码',
    name VARCHAR(128) NOT NULL COMMENT '组件名称',
    description VARCHAR(512) COMMENT '组件描述',
    extraction_type VARCHAR(32) NOT NULL COMMENT '抽取类型：DIM-维度抽取、FACT-事实抽取',
    data_source_type VARCHAR(32) NOT NULL COMMENT '数据源类型：DB-数据库、MQ-消息队列、API-接口、FILE-文件、STREAM-流',
    data_source_id VARCHAR(64) COMMENT '数据源连接ID（外键）',
    is_incremental TINYINT DEFAULT 0 COMMENT '是否增量抽取：0-全量 1-增量',
    incremental_field VARCHAR(64) COMMENT '增量标识字段',
    status TINYINT DEFAULT 0 COMMENT '状态：0-草稿 1-已发布 2-已弃用',
    creator VARCHAR(64) COMMENT '创建人',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updater VARCHAR(64) COMMENT '更新人',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_extraction_type (extraction_type),
    INDEX idx_data_source_type (data_source_type),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='抽取组件基础信息表';

-- 3. 转换组件基础信息表
CREATE TABLE transform_component_basic_info (
    component_code VARCHAR(64) PRIMARY KEY COMMENT '组件编码',
    name VARCHAR(128) NOT NULL COMMENT '组件名称',
    description VARCHAR(512) COMMENT '组件描述',
    transform_type VARCHAR(32) NOT NULL COMMENT '转换类型：MAPPING-映射、FILTER-过滤、ROUTE-路由、AGGREGATE-聚合、JOIN-关联',
    multiple_inputs TINYINT DEFAULT 0 COMMENT '是否支持多输入：0-单输入 1-多输入',
    multiple_outputs TINYINT DEFAULT 0 COMMENT '是否支持多输出：0-单输出 1-多输出',
    status TINYINT DEFAULT 0 COMMENT '状态：0-草稿 1-已发布 2-已弃用',
    creator VARCHAR(64) COMMENT '创建人',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updater VARCHAR(64) COMMENT '更新人',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_transform_type (transform_type),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='转换组件基础信息表';

-- 4. 加载组件基础信息表
CREATE TABLE load_component_basic_info (
    component_code VARCHAR(64) PRIMARY KEY COMMENT '组件编码',
    name VARCHAR(128) NOT NULL COMMENT '组件名称',
    description VARCHAR(512) COMMENT '组件描述',
    data_source_type VARCHAR(32) NOT NULL COMMENT '数据源类型：DB-数据库、API-接口、MQ-消息队列、FILE-文件、CACHE-缓存',
    data_source_id VARCHAR(64) COMMENT '数据源连接ID（外键）',
    load_mode VARCHAR(32) DEFAULT 'INSERT' COMMENT '加载模式：INSERT-插入、UPDATE-更新、UPSERT-插入或更新、DELETE-删除',
    batch_size INT DEFAULT 1000 COMMENT '批量大小',
    status TINYINT DEFAULT 0 COMMENT '状态：0-草稿 1-已发布 2-已弃用',
    creator VARCHAR(64) COMMENT '创建人',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updater VARCHAR(64) COMMENT '更新人',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_data_source_type (data_source_type),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='加载组件基础信息表';

-- 5. 管道组件实例表
CREATE TABLE pipeline_component_instance (
    instance_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '实例ID',
    pipeline_code VARCHAR(64) NOT NULL COMMENT '管道编码',
    component_code VARCHAR(64) NOT NULL COMMENT '组件编码',
    component_type VARCHAR(32) NOT NULL COMMENT '组件类型：EXTRACTION_DIM、EXTRACTION_FACT、TRANSFORM、LOAD',
    instance_name VARCHAR(128) COMMENT '组件在管道中的别名',
    execution_order INT COMMENT '执行顺序',
    enabled TINYINT DEFAULT 1 COMMENT '是否启用：0-禁用 1-启用',
    exception_handler VARCHAR(32) DEFAULT 'FAIL' COMMENT '异常处理策略：SKIP-跳过、RETRY-重试、FAIL-失败终止、CONTINUE-继续',
    retry_times INT DEFAULT 0 COMMENT '重试次数',
    retry_interval INT DEFAULT 0 COMMENT '重试间隔（秒）',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (pipeline_code) REFERENCES pipeline_basic_info(pipeline_code) ON DELETE CASCADE,
    INDEX idx_pipeline_code (pipeline_code),
    INDEX idx_component_code (component_code),
    INDEX idx_component_type (component_type),
    UNIQUE KEY uk_pipeline_component (pipeline_code, component_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='管道组件实例表';

-- 6. 管道组件关系表（DAG）
CREATE TABLE pipeline_component_relation (
    relation_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '关系ID',
    pipeline_code VARCHAR(64) NOT NULL COMMENT '管道编码',
    source_instance_id BIGINT NOT NULL COMMENT '上游组件实例ID',
    target_instance_id BIGINT NOT NULL COMMENT '下游组件实例ID',
    relation_type VARCHAR(32) DEFAULT 'SEQUENTIAL' COMMENT '关系类型：SEQUENTIAL-顺序、PARALLEL-并行、CONDITIONAL-条件',
    condition_expression VARCHAR(512) COMMENT '条件表达式',
    output_port VARCHAR(64) COMMENT '输出端口名称',
    input_port VARCHAR(64) COMMENT '输入端口名称',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    FOREIGN KEY (pipeline_code) REFERENCES pipeline_basic_info(pipeline_code) ON DELETE CASCADE,
    FOREIGN KEY (source_instance_id) REFERENCES pipeline_component_instance(instance_id) ON DELETE CASCADE,
    FOREIGN KEY (target_instance_id) REFERENCES pipeline_component_instance(instance_id) ON DELETE CASCADE,
    INDEX idx_pipeline_code (pipeline_code),
    INDEX idx_source_instance (source_instance_id),
    INDEX idx_target_instance (target_instance_id),
    UNIQUE KEY uk_relation (source_instance_id, target_instance_id, output_port, input_port)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='管道组件关系表';
